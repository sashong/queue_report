<div class="container">

  <h1>Queue Status Dashboard</h1>

  <!-- Error -->
  <div class="error" *ngIf="error">{{ error }}</div>

  <!-- Queue Selection -->
  <div class="card">
    <label>Select Queue</label>

    <select [(ngModel)]="selectedQueueId" [disabled]="loading">
      <option value="">-- Select --</option>
      <option *ngFor="let q of queues" [value]="q.id">
        {{ q.queuename }}
      </option>
    </select>

    <button (click)="loadReport()" [disabled]="loading || !selectedQueueId">
      Load Report
    </button>
  </div>

  <!-- Loading -->
  <div class="loading" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading data, please wait...</p>
  </div>

  <div class="search-bar" *ngIf="allRecords.length > 0">
  <input
    type="text"
    placeholder="Search by Product or Participant..."
    [(ngModel)]="searchText"
    (input)="applyFilters()"
  />
</div>


  <!-- REPORT TABLE -->
  <table *ngIf="filteredRecords.length > 0">

  <thead>
  <tr>
    
    <th>Participant Name</th>
    <th>Product Name</th>
    

    <!-- PRODUCT STATUS -->
    <th class="filter-header">
      <div class="filter-container">
        <span>Product Status</span>
        <span class="filter-icon" (click)="toggleFilter('status')">▼</span>

        <div class="filter-popup" *ngIf="activeFilter === 'status'">
          <select
            [(ngModel)]="selectedProductStatus"
            (change)="applyFilters(); closeFilter()">
            <option value="">All</option>
            <option *ngFor="let o of productStatusOptions" [value]="o.value">
              {{ o.value }} ({{ o.count }})
            </option>
          </select>
        </div>
      </div>
    </th>

    <!-- INTEGRATION MODE -->
    <th class="filter-header">
      <div class="filter-container">
        <span>Integration Mode</span>
        <span class="filter-icon" (click)="toggleFilter('mode')">▼</span>

        <div class="filter-popup" *ngIf="activeFilter === 'mode'">
          <select
            [(ngModel)]="selectedIntegrationMode"
            (change)="applyFilters(); closeFilter()">
            <option value="">All</option>
            <option *ngFor="let o of integrationModeOptions" [value]="o.value">
              {{ o.value }} ({{ o.count }})
            </option>
          </select>
        </div>
      </div>
    </th>

    <!-- CURRENT STAGE -->
    <th class="filter-header">
      <div class="filter-container">
        <span>Current Stage</span>
        <span class="filter-icon" (click)="toggleFilter('stage')">▼</span>

        <div class="filter-popup" *ngIf="activeFilter === 'stage'">
          <select
            [(ngModel)]="selectedStage"
            (change)="applyFilters(); closeFilter()">
            <option value="">All</option>
            <option *ngFor="let o of stageOptions" [value]="o.value">
              {{ o.value }} ({{ o.count }})
            </option>
          </select>
        </div>
      </div>
    </th>

    <th>Validation</th>
  </tr>
</thead>


  <tbody>
    <tr *ngFor="let r of filteredRecords">
      <td>{{ r.participantName }}</td>
      <td>{{ r.productName || '-' }}</td>
      <td>{{ r.productStatus }}</td>
      <td>{{ r.integrationMode || 'N/A' }}</td>
      <td>{{ r.tokenStage }}</td>
      <td>
        <span class="ok" *ngIf="r.validationPassed">✔ Valid</span>
        <span class="fail" *ngIf="!r.validationPassed">✖ Invalid</span>
      </td>
    </tr>
  </tbody>

</table>

  <!-- VALIDATION FAILURES -->
  <div class="card danger" *ngIf="validationFailures.length > 0">

    <h3>Validation Failures</h3>

    <ul>
      <li *ngFor="let v of validationFailures">
        <strong>{{ v.participantName }}</strong><br />
        Product: {{ v.productName }}<br />
        <span style="color:#b00020">{{ v.validationReason }}</span><br />
        <small>
          Current Stage: {{ v.tokenStage }} |
          Product Status: {{ v.productStatus }}
        </small>
      </li>
    </ul>

  </div>

  <!-- SUMMARY -->
  <div class="card summary" *ngIf="summary">
    <h3>Summary</h3>
    <p>Total Records: {{ summary.recordsReported }}</p>
    <p>Validation Failures: {{ summary.validationFailures }}</p>
  </div>

</div>
