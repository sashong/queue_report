

<div class="container" *ngIf="showDashboard">

  <button (click)="logout()" style="float:right">Logout</button>

  <h1>Queue Status Dashboard</h1>

  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
  </div>

  <!-- KPI DASHBOARD -->
  <div class="kpi-grid" *ngIf="reportLoaded">
    <div class="kpi"
         (click)="activeKpiFilter=null; applyFilters()"
         [class.active]="activeKpiFilter===null">
      <div class="kpi-value">{{ dashboard.total }}</div>
      <div class="kpi-label">Total Records</div>
    </div>

    <div class="kpi"
         (click)="onKpiClick('completed')"
         [class.active]="activeKpiFilter==='completed'">
      <div class="kpi-value">{{ dashboard.completed }}</div>
      <div class="kpi-label">Completed</div>
    </div>

    <div class="kpi"
         (click)="onKpiClick('initiated')"
         [class.active]="activeKpiFilter==='initiated'">
      <div class="kpi-value">{{ dashboard.initiated }}</div>
      <div class="kpi-label">Initiated</div>
    </div>

    <div class="kpi"
         (click)="onKpiClick('ongoing')"
         [class.active]="activeKpiFilter==='ongoing'">
      <div class="kpi-value">{{ dashboard.ongoing }}</div>
      <div class="kpi-label">Ongoing</div>
    </div>

    <div class="kpi"
         (click)="onKpiClick('cancelled')"
         [class.active]="activeKpiFilter==='cancelled'">
      <div class="kpi-value">{{ dashboard.cancelled }}</div>
      <div class="kpi-label">Cancelled</div>
    </div>

    <div class="kpi"
         (click)="onKpiClick('valid')"
         [class.active]="activeKpiFilter==='valid'">
      <div class="kpi-value">{{ dashboard.total - dashboard.failed }}</div>
      <div class="kpi-label">Valid</div>
    </div>

    <div class="kpi"
         (click)="onKpiClick('invalid')"
         [class.active]="activeKpiFilter==='invalid'">
      <div class="kpi-value">{{ dashboard.failed }}</div>
      <div class="kpi-label">Invalid</div>
    </div>
  </div>

  <!-- ACTION ROW -->
  <div class="card action-row">
    <div class="left-actions">

      <!-- QUEUE SELECT (UNCHANGED LOGIC) -->
      <div class="queue-select-container">
        <input
          type="text"
          class="queue-input"
          placeholder="Select Queue"
          [(ngModel)]="queueSearchText"
          (focus)="openQueueDropdown()"
          (input)="filterQueues()"
          [readonly]="!showQueueDropdown"
        />

        <div class="queue-dropdown" *ngIf="showQueueDropdown">
        <div
          class="queue-option"
          *ngFor="let q of filteredQueues; trackBy: trackByQueueId"
          (click)="selectQueue(q)">
          {{ q.queuename }}
        </div>

          <div class="no-results" *ngIf="filteredQueues.length === 0">
            No queues found
          </div>
        </div>
      </div>

    </div>

    <div class="right-actions">
      <input
        type="text"
        placeholder="Search..."
        [(ngModel)]="searchText"
        (input)="applyFilters()" />

      <button class="btn-outline" (click)="exportCSV()">Export CSV</button>
    </div>
  </div>

  <!-- ALL TOKENS TABLE -->
<div class="table-wrapper" *ngIf="reportLoaded && allTokensRecords.length > 0">
  <table>
    <thead>
      <tr>
        <th>Participant</th>
        <th>Product</th>
        <th>Token Status</th>
        <th>Stage Status</th>
        <th>Current Stage</th>
        <th>Mode</th>
        <th>Product Status</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let r of allTokensRecords">
        <td>{{ r.participantName }}</td>
        <td>{{ r.productName }}</td>
        <td>{{ r.tokenStatus }}</td>
        <td>{{ r.stageStatus }}</td>
        <td>{{ r.currentStage }}</td>
        <td>{{ r.mode }}</td>
        <td>{{ r.productStatus }}</td>
      </tr>
    </tbody>
  </table>
</div>


  <!-- TABLE -->
  <h2 style="margin: 20px 0 10px 0;">
    Validation Summary (Active & Approved Records)
  </h2>

  <div class="table-wrapper">

    <table *ngIf="reportLoaded && paginatedRecords.length > 0">
      <thead>
        <tr>
          <th>Participant</th>
          <th>Product</th>
          <th>Product Status</th>
          <th class="filter-header">
            <span>Mode</span>

            <div class="filter-wrapper">
              <span class="filter-icon" (click)="toggleFilter('mode')">▼</span>

              <div class="filter-dropdown" *ngIf="activeFilter === 'mode'">
                <div class="filter-option" (click)="selectedIntegrationMode=''; applyFilters()">
                  All
                </div>

                <div
                  class="filter-option"
                  *ngFor="let mode of integrationModeOptions"
                  (click)="selectedIntegrationMode=mode; applyFilters()">
                  {{ mode.value }} ({{ mode.count }})
                </div>
              </div>
            </div>
          </th>

          <th class="filter-header">
            <span>Stage</span>

            <div class="filter-wrapper">
              <span class="filter-icon" (click)="toggleFilter('stage')">▼</span>

              <div class="filter-dropdown" *ngIf="activeFilter === 'stage'">
                <div class="filter-option" (click)="selectedStage=''; applyFilters()">
                  All
                </div>

                <div
                  class="filter-option"
                  *ngFor="let stage of stageOptions"
                  (click)="selectedStage=stage; applyFilters()">
                  {{ stage }}
                </div>
              </div>
            </div>
          </th>



          <th>Validation</th>
          <th>Reason</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngIf="!loading && filteredRecords.length === 0">
          <td colspan="6" style="text-align: center; padding: 16px;">
            No records match the selected filters
          </td>
        </tr>

        <tr *ngFor="let r of paginatedRecords">
          <td>{{ r.participantName }}</td>
          <td>{{ r.productName }}</td>
          <td>{{ r.productStatus }}</td>
          <td>{{ r.integrationMode }}</td>
          <td>{{ r.tokenStage }}</td>
          <td>
            <span class="ok" *ngIf="r.validationPassed">✔ Valid</span>
            <span class="fail" *ngIf="!r.validationPassed">✖ Invalid</span>
          </td>
          <td>{{ r.validationReason }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- PAGINATION -->
  <div class="pagination" *ngIf="reportLoaded && totalPages > 1">
    <button (click)="prevPage()">Prev</button>
    Page {{ currentPage }} / {{ totalPages }}
    <button (click)="nextPage()">Next</button>
  </div>

</div>
<router-outlet *ngIf="!showDashboard"></router-outlet>
