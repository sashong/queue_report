<div class="container" *ngIf="showDashboard">

  <button (click)="logout()" style="float:right">Logout</button>

  <h1>Queue Status Dashboard</h1>

  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
  </div>

  <!-- KPI DASHBOARD -->
  <div class="kpi-grid" *ngIf="reportLoaded">
    <div class="kpi"
         (click)="activeKpiFilter=null; applyFilters()"
         [class.active]="activeKpiFilter===null">
      <div class="kpi-value">{{ dashboard.total }}</div>
      <div class="kpi-label">Total Records</div>
    </div>

    <div class="kpi"
         (click)="onKpiClick('completed')"
         [class.active]="activeKpiFilter==='completed'">
      <div class="kpi-value">{{ dashboard.completed }}</div>
      <div class="kpi-label">Completed</div>
    </div>

    <div class="kpi"
         (click)="onKpiClick('initiated')"
         [class.active]="activeKpiFilter==='initiated'">
      <div class="kpi-value">{{ dashboard.initiated }}</div>
      <div class="kpi-label">Initiated</div>
    </div>

    <div class="kpi"
         (click)="onKpiClick('ongoing')"
         [class.active]="activeKpiFilter==='ongoing'">
      <div class="kpi-value">{{ dashboard.ongoing }}</div>
      <div class="kpi-label">Ongoing</div>
    </div>

    <div class="kpi"
         (click)="onKpiClick('cancelled')"
         [class.active]="activeKpiFilter==='cancelled'">
      <div class="kpi-value">{{ dashboard.cancelled }}</div>
      <div class="kpi-label">Cancelled</div>
    </div>

    <div class="kpi"
         (click)="onKpiClick('valid')"
         [class.active]="activeKpiFilter==='valid'">
      <div class="kpi-value">{{ dashboard.total - dashboard.failed }}</div>
      <div class="kpi-label">Valid</div>
    </div>

    <div class="kpi"
         (click)="onKpiClick('invalid')"
         [class.active]="activeKpiFilter==='invalid'">
      <div class="kpi-value">{{ dashboard.failed }}</div>
      <div class="kpi-label">Invalid</div>
    </div>
  </div>

  <!-- ACTION ROW -->
  <div class="card action-row">
    <div class="left-actions">

      <!-- QUEUE SELECT (UNCHANGED LOGIC) -->
      <div class="queue-select-container">
        <input
          type="text"
          class="queue-input"
          placeholder="Select Queue"
          [(ngModel)]="queueSearchText"
          (focus)="openQueueDropdown()"
          (input)="filterQueues()"
          [readonly]="!showQueueDropdown"
        />

        <div class="queue-dropdown" *ngIf="showQueueDropdown">
          <div
            class="queue-option"
            *ngFor="let q of filteredQueues"
            (click)="selectQueue(q)">
            {{ q.queuename }}
          </div>

          <div class="no-results" *ngIf="filteredQueues.length === 0">
            No queues found
          </div>
        </div>
      </div>

    </div>

    <div class="right-actions">
      <input
        type="text"
        placeholder="Search..."
        [(ngModel)]="searchText"
        (input)="applyFilters()" />

      <button class="btn-outline" (click)="exportCSV()">Export CSV</button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-wrapper">
    <table *ngIf="reportLoaded && paginatedRecords.length > 0">
      <thead>
        <tr>
          <th>Participant</th>
          <th>Product</th>
          <th>Product Status</th>
          <th>Mode</th>
          <th>Stage</th>
          <th>Validation</th>
          <th>Reason</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let r of paginatedRecords">
          <td>{{ r.participantName }}</td>
          <td>{{ r.productName }}</td>
          <td>{{ r.productStatus }}</td>
          <td>{{ r.integrationMode }}</td>
          <td>{{ r.tokenStage }}</td>
          <td>
            <span class="ok" *ngIf="r.validationPassed">✔ Valid</span>
            <span class="fail" *ngIf="!r.validationPassed">✖ Invalid</span>
          </td>
          <td>{{ r.validationReason }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- PAGINATION -->
  <div class="pagination" *ngIf="reportLoaded && totalPages > 1">
    <button (click)="prevPage()">Prev</button>
    Page {{ currentPage }} / {{ totalPages }}
    <button (click)="nextPage()">Next</button>
  </div>

</div>

<router-outlet *ngIf="!showDashboard"></router-outlet>
